---
# Source: parent-control-app/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: parent-control-app
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
---
# Source: parent-control-app/templates/proxy-dns-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: parent-control-app-dns
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: proxy
    service: dns
spec:
  type: LoadBalancer
  loadBalancerIP: 192.168.77.252
  ports:
    - port: 53
      targetPort: 53
      protocol: UDP
      name: dns-udp
    - port: 53
      targetPort: 53
      protocol: TCP
      name: dns-tcp
  selector:
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/component: proxy
---
# Source: parent-control-app/templates/proxy-headless-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: parent-control-app-proxy-headless
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: proxy
spec:
  clusterIP: None
  ports:
    - port: 8081
      targetPort: 8081
      protocol: TCP
      name: mitmweb
  selector:
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/component: proxy
---
# Source: parent-control-app/templates/proxy-http-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: parent-control-app-proxy
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: proxy
    service: proxy
spec:
  type: LoadBalancer
  loadBalancerIP: 192.168.77.251
  ports:
    - port: 80
      targetPort: 80
      protocol: TCP
      name: http
    - port: 443
      targetPort: 443
      protocol: TCP
      name: https
  selector:
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/component: proxy
---
# Source: parent-control-app/templates/proxy-mitmweb-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: parent-control-app-mitmweb
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: proxy
    service: mitmweb
spec:
  type: ClusterIP
  ports:
    - port: 8081
      targetPort: 8081
      protocol: TCP
      name: web
  selector:
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/component: proxy
    statefulset.kubernetes.io/pod-name: parent-control-app-proxy-0
---
# Source: parent-control-app/templates/pwa-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: parent-control-app-pwa
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: pwa
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/component: pwa
---
# Source: parent-control-app/templates/pwa-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: parent-control-app-pwa
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: pwa
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: parent-control-app
      app.kubernetes.io/instance: parent-control-app
      app.kubernetes.io/component: pwa
  template:
    metadata:
      labels:
        app.kubernetes.io/name: parent-control-app
        app.kubernetes.io/instance: parent-control-app
        app.kubernetes.io/component: pwa
    spec:
      serviceAccountName: parent-control-app
      securityContext:
        fsGroup: 2000
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: pwa
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 1001
          image: "gitea.homelab.int.zengarden.space/zengarden-space/parent-control-app-pwa:sha-c7c170f"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 3000
              protocol: TCP
          env:
            - name: "DB_HOST"
              value: "parent-control-app-psql-rw"
            - name: "DB_NAME"
              value: "parent_control"
            - name: "DB_PORT"
              value: "5432"
            - name: "DB_USER"
              value: "app-user"
            - name: "NODE_ENV"
              value: "development"
          envFrom:
            - secretRef:
                name: parent-control-app-envs-secrets
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
          resources:
            limits:
              cpu: 250m
              memory: 256Mi
            requests:
              cpu: 50m
              memory: 64Mi
---
# Source: parent-control-app/templates/proxy-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: parent-control-app-proxy
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: proxy
spec:
  serviceName: parent-control-app-proxy-headless
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: parent-control-app
      app.kubernetes.io/instance: parent-control-app
      app.kubernetes.io/component: proxy
  template:
    metadata:
      labels:
        app.kubernetes.io/name: parent-control-app
        app.kubernetes.io/instance: parent-control-app
        app.kubernetes.io/component: proxy
    spec:
      shareProcessNamespace: true
      serviceAccountName: parent-control-app
      securityContext:
        fsGroup: 2000
      containers:
        - name: controller
          image: "gitea.homelab.int.zengarden.space/zengarden-space/parent-control-app-controller:sha-c7c170f"
          imagePullPolicy: IfNotPresent
          env:
            - name: PWA_SERVICE_URL
              value: "http://parent-control-app-pwa/api/sse"
            - name: CA_CERT_PATH
              value: "/ca-cert/tls.crt"
            - name: CA_KEY_PATH
              value: "/ca-cert/tls.key"
            - name: CONFIG_DIR
              value: "/config"
            - name: CERTS_DIR
              value: "/certs"
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: PROXY_LOADBALANCER_IP
              value: "192.168.77.251"
          envFrom:
            - secretRef:
                name: parent-control-app-envs-secrets
          volumeMounts:
            - name: config
              mountPath: /config
            - name: certs
              mountPath: /certs
            - name: ca-cert
              mountPath: /ca-cert
              readOnly: true
            - name: mitmproxy-data
              mountPath: /mitmproxy-data
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi
      volumes:
        - name: config
          emptyDir: {}
        - name: certs
          emptyDir: {}
        - name: ca-cert
          secret:
            secretName: parent-control-ca-key-pair
  volumeClaimTemplates:
    - metadata:
        name: mitmproxy-data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 10Gi
---
# Source: parent-control-app/templates/db-init-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: parent-control-app-db-init-v1
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: database-init
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        app.kubernetes.io/name: parent-control-app
        app.kubernetes.io/instance: parent-control-app
        app.kubernetes.io/component: database-init
    spec:
      restartPolicy: OnFailure
      serviceAccountName: parent-control-app
      securityContext:
        fsGroup: 2000
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: db-init
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 1001
          image: postgres:16-alpine
          imagePullPolicy: IfNotPresent
          env:
            - name: PGHOST
              value: parent-control-app-psql-rw
            - name: PGPORT
              value: "5432"
            - name: PGDATABASE
              value: "parent_control"
            - name: PGUSER
              value: "app-owner"
            - name: PGPASSWORD
              valueFrom:
                secretKeyRef:
                  name: "app-owner"
                  key: password
          command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Waiting for PostgreSQL to be ready..."
              until pg_isready -h $PGHOST -p $PGPORT -U $PGUSER; do
                echo "Waiting for database..."
                sleep 2
              done

              echo "Creating tables and triggers..."
              psql <<'EOF'
              -- Create shared_urls table
              CREATE TABLE IF NOT EXISTS shared_urls (
                id BIGSERIAL PRIMARY KEY,
                url TEXT NOT NULL,
                shared_at TIMESTAMPTZ DEFAULT NOW()
              );

              -- Create observable_routes table
              CREATE TABLE IF NOT EXISTS observable_routes (
                id BIGSERIAL PRIMARY KEY,
                host TEXT NOT NULL,
                path_prefix TEXT DEFAULT '/',
                created_at TIMESTAMPTZ DEFAULT NOW(),
                deleted_at TIMESTAMPTZ,
                UNIQUE(host, path_prefix)
              );

              -- Create notify function
              CREATE OR REPLACE FUNCTION notify_config_change()
              RETURNS TRIGGER AS \$\$
              BEGIN
                PERFORM pg_notify('config_changes',
                  json_build_object(
                    'table', TG_TABLE_NAME,
                    'operation', TG_OP,
                    'data', CASE
                      WHEN TG_OP = 'DELETE' THEN row_to_json(OLD)
                      ELSE row_to_json(NEW)
                    END
                  )::text
                );
                RETURN NEW;
              END;
              \$\$ LANGUAGE plpgsql;

              -- Drop existing triggers if they exist
              DROP TRIGGER IF EXISTS shared_urls_notify ON shared_urls;
              DROP TRIGGER IF EXISTS observable_routes_notify ON observable_routes;

              -- Create triggers
              CREATE TRIGGER shared_urls_notify
              AFTER INSERT OR UPDATE OR DELETE ON shared_urls
              FOR EACH ROW EXECUTE FUNCTION notify_config_change();

              CREATE TRIGGER observable_routes_notify
              AFTER INSERT OR UPDATE OR DELETE ON observable_routes
              FOR EACH ROW EXECUTE FUNCTION notify_config_change();

              -- Grant permissions to app user
              GRANT SELECT, INSERT, UPDATE, DELETE ON shared_urls TO "app-user";
              GRANT SELECT, INSERT, UPDATE, DELETE ON observable_routes TO "app-user";
              GRANT USAGE, SELECT ON SEQUENCE shared_urls_id_seq TO "app-user";
              GRANT USAGE, SELECT ON SEQUENCE observable_routes_id_seq TO "app-user";

              EOF

              echo "Database initialization completed successfully"
          resources:
            limits:
              cpu: 200m
              memory: 128Mi
            requests:
              cpu: 50m
              memory: 64Mi
---
# Source: parent-control-app/templates/proxy-mitmweb-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: parent-control-app-mitmweb
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: proxy
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: internal
  tls:
    - hosts:
        - "mitmproxy-0.parent-control.homelab.int.zengarden.space"
      secretName: mitmproxy-tls
  rules:
    - host: "mitmproxy-0.parent-control.homelab.int.zengarden.space"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: parent-control-app-mitmweb
                port:
                  number: 8081
---
# Source: parent-control-app/templates/pwa-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: parent-control-app-pwa
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: pwa
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  ingressClassName: internal
  tls:
    - hosts:
        - "parent-control.homelab.int.zengarden.space"
      secretName: parent-control-pwa-tls
  rules:
    - host: "parent-control.homelab.int.zengarden.space"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: parent-control-app-pwa
                port:
                  number: 80
---
# Source: parent-control-app/templates/ca-certificate.yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: parent-control-app-ca
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
spec:
  isCA: true
  commonName: "Parent Control CA"
  secretName: parent-control-ca-key-pair
  duration: 87600h
  renewBefore: 8760h
  subject:
    organizations:
      - "Parent Control System"
    organizationalUnits:
      - "Homelab"
  issuerRef:
    name: parent-control-ca-issuer
    kind: Issuer
    group: cert-manager.io
---
# Source: parent-control-app/templates/postgresql.yaml
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: parent-control-app-psql
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: database
spec:
  instances: 1
  storage:
    size: 10Gi
  managed:
    roles:
      - name: "app-user"
        ensure: present
        login: true
        passwordSecret:
          name: "app-user"
      - name: "app-owner"
        ensure: present
        login: true
        passwordSecret:
          name: "app-owner"
---
# Source: parent-control-app/templates/postgresql.yaml
apiVersion: postgresql.cnpg.io/v1
kind: Database
metadata:
  name: parent-control-app-db
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/component: database
spec:
  name: "parent_control"
  owner: "app-owner"
  cluster:
    name: parent-control-app-psql
  extensions:
    - name: uuid-ossp
      ensure: present
---
# Source: parent-control-app/templates/derived-secret.yaml
apiVersion: secrets.oleksiyp.dev/v1alpha1
kind: DerivedSecret
metadata:
  name: apps-dev-parent-control-app-derived
  namespace: secrets
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
spec:
  keys:
    appDbUserPassword:
      type: password
    appDbOwnerUserPassword:
      type: password
---
# Source: parent-control-app/templates/external-secrets.yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: parent-control-app-envs-secrets
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
spec:
  refreshInterval: 15s
  secretStoreRef:
    name: secrets
    kind: ClusterSecretStore
  target:
    name: parent-control-app-envs-secrets
    creationPolicy: Owner
    template:
      data:
        DB_PASSWORD: '{{ .appDbUserPassword }}'
  dataFrom:
    - extract:
        key: "apps-dev-parent-control-app"
    - extract:
        key: apps-dev-parent-control-app-derived
---
# Source: parent-control-app/templates/external-secrets.yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: parent-control-app-owner-user
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
spec:
  refreshInterval: 15s
  secretStoreRef:
    name: secrets
    kind: ClusterSecretStore
  target:
    name: "app-owner"
    creationPolicy: Owner
    template:
      type: kubernetes.io/basic-auth
      data:
        username: "app-owner"
        password: "{{ .appDbOwnerUserPassword }}"
  dataFrom:
    - extract:
        key: apps-dev-parent-control-app-derived
---
# Source: parent-control-app/templates/external-secrets.yaml
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: parent-control-app-user
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
spec:
  refreshInterval: 15s
  secretStoreRef:
    name: secrets
    kind: ClusterSecretStore
  target:
    name: "app-user"
    creationPolicy: Owner
    template:
      type: kubernetes.io/basic-auth
      data:
        username: "app-user"
        password: "{{ .appDbUserPassword }}"
  dataFrom:
    - extract:
        key: apps-dev-parent-control-app-derived
---
# Source: parent-control-app/templates/ca-issuer.yaml
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: parent-control-ca-issuer
  namespace: apps-dev-parent-control-app
  labels:
    helm.sh/chart: parent-control-app-0.1.0
    app.kubernetes.io/name: parent-control-app
    app.kubernetes.io/instance: parent-control-app
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/managed-by: Helm
spec:
  selfSigned: {}
